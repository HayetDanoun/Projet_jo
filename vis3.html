<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Advanced Interactive Bar Chart Visualization (D3)</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- D3.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <!-- html2canvas pour "save as image" -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f9fc;
      margin: 0;
      padding: 0;
    }
    .navbar {
      margin-bottom: 0;
    }
    .hero {
      background: #007bff;
      color: #fff;
      padding: 40px 20px;
      text-align: center;
      margin-bottom: 0;
    }
    #chart-container {
      width: 80%;
      margin: 40px auto;
      background: #fff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      padding: 20px;
      position: relative;
    }
    #chart-title {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      color: #555;
      margin-bottom: 10px;
    }
    #chart {
      display: block;
      margin: 0 auto;
      background: #fff;
    }
    .legend {
      text-align: center;
      margin-bottom: 1rem;
    }
    .legend-item {
      display: inline-flex;
      align-items: center;
      margin: 0 10px;
      font-size: 14px;
      color: #555;
    }
    .legend-color {
      width: 15px;
      height: 15px;
      border-radius: 3px;
      margin-right: 5px;
      background: #5470C6;
    }
    .tooltip-d3 {
      position: absolute;
      pointer-events: none;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 8px;
      font-size: 13px;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
      opacity: 0;
      transition: opacity 0.1s ease;
      z-index: 999;
    }
    #brush-area {
      margin-top: 10px;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 1rem;
    }
    .toolbar button {
      margin: 5px;
    }
    .modal-bg {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none; /* caché par défaut */
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h5 {
      margin: 0;
    }
    .modal-footer {
      text-align: right;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">Datavisualisation JO 2024</a>
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navbarNav"
        aria-controls="navbarNav"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link active" href="vis1.html">Visualisation 1</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="vis2.html">Visualisation 2</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="vis3.html">Visualisation 3</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="vis4.html">Visualisation 4</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="vis5.html">Visualisation 5</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="vis6.html">Visualisation 6</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- SECTION HERO -->
  <header class="hero">
    <h1>Répartition des Voyages par Mode (D3)</h1>
  </header>

  <!-- CONTENEUR PRINCIPAL DU CHART ET OUTILS -->
  <div id="chart-container">
    <div id="chart-title">Répartition des Voyages par Mode</div>

    <!-- Légende (une seule série "Voyages") -->
    <div class="legend">
      <div class="legend-item">
        <div class="legend-color"></div>
        <span>Voyages</span>
      </div>
    </div>

    <!-- Barre d’outils (simule ECharts toolbox) -->
    <div class="toolbar">
      <button id="toggle-chart" class="btn btn-sm btn-primary">
        Basculer Bar/Line
      </button>
      <button id="open-data-view" class="btn btn-sm btn-warning">
        DataView
      </button>
      <button id="restore-btn" class="btn btn-sm btn-secondary">
        Restore
      </button>
      <button id="save-as-img" class="btn btn-sm btn-success">
        Save as Image
      </button>
    </div>

    <!-- SVG principal -->
    <svg id="chart" width="800" height="400"></svg>

    <!-- Zone brush (pour dataZoom) -->
    <div id="brush-area">
      <svg id="brush-svg" width="800" height="80"></svg>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip-d3"></div>
  </div>

  <!-- Modale pour DataView -->
  <div class="modal-bg" id="data-view-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Modifier les données</h5>
        <button class="btn-close" id="close-data-view"></button>
      </div>
      <textarea
        id="data-textarea"
        rows="10"
        style="width: 100%; font-family: monospace; white-space: pre;"
      ></textarea>
      <div class="modal-footer">
        <button class="btn btn-primary" id="apply-data">Appliquer</button>
      </div>
    </div>
  </div>

  <!-- Script Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- SCRIPT PRINCIPAL D3 -->
  <script>
    // Données initiales
    let data = [
      { mode: "Vélo", voyages: 567 },
      { mode: "Bus", voyages: 156 },
      { mode: "Marche", voyages: 5058 },
      { mode: "TGV", voyages: 84 },
      { mode: "Moto", voyages: 92 },
      { mode: "Voiture", voyages: 3061 },
      { mode: "Avion", voyages: 17 },
      { mode: "Train/Métro", voyages: 4204 },
      { mode: "Trottinette", voyages: 10 },
      { mode: "Inconnu", voyages: 186 },
    ];

    // Dimensions principales
    const margin = { top: 40, right: 30, bottom: 50, left: 70 };
    const w = 800, h = 400;
    const innerWidth = w - margin.left - margin.right;
    const innerHeight = h - margin.top - margin.bottom;

    // Sélection du SVG principal
    const svg = d3.select("#chart");
    const chartG = svg.append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    // Échelles X / Y
    let x = d3.scaleBand()
      .domain(data.map(d => d.mode))
      .range([0, innerWidth])
      .padding(0.2);

    let y = d3.scaleLinear()
      .domain([0, d3.max(data, d => d.voyages)])
      .nice()
      .range([innerHeight, 0]);

    // Axes
    const xAxis = d3.axisBottom(x).tickSizeOuter(0);
    const yAxis = d3.axisLeft(y);

    // Groupes axes
    const xAxisG = chartG.append("g")
      .attr("class", "x-axis")
      .attr("transform", `translate(0, ${innerHeight})`)
      .call(xAxis)
      .selectAll("text")
      .attr("transform", "rotate(30)")
      .style("text-anchor", "start")
      .style("font-size", "12px");

    chartG.append("g")
      .attr("class", "y-axis")
      .call(yAxis);

    // Group principal pour nos barres / points / line
    const seriesGroup = chartG.append("g").attr("class", "series-group");

    // État : bar ou line
    let currentType = "bar";

    // Tooltip
    const tooltip = d3.select("#tooltip");

    // --- FONCTION DE DESSIN ---
    function drawChart() {
      // On récupère la liste filtrée : uniquement les catégories dans x.domain()
      const domainSet = new Set(x.domain());
      const visibleData = data.filter(d => domainSet.has(d.mode));

      // Supprime barres & lignes existantes
      seriesGroup.selectAll("rect").remove();
      seriesGroup.selectAll(".line-path").remove();
      seriesGroup.selectAll(".line-circle").remove();

      if (currentType === "bar") {
        // BARCHART
        const bars = seriesGroup.selectAll(".bar")
          .data(visibleData, d => d.mode);

        bars.enter()
          .append("rect")
          .attr("class", "bar")
          .merge(bars)
          .attr("x", d => x(d.mode))
          .attr("width", x.bandwidth())
          .attr("fill", (d, i) => {
            const colors = [
              '#5470C6','#91CC75','#EE6666','#FAC858',
              '#73C0DE','#3BA272','#FC8452','#9A60B4',
              '#EA7CCC','#FF9F7F'
            ];
            return colors[i % colors.length];
          })
          .transition()
          .duration(300)
          .attr("y", d => y(d.voyages))
          .attr("height", d => y(0) - y(d.voyages));

        bars.exit().remove();

      } else {
        // LINECHART
        // Path
        const line = d3.line()
          .x(d => x(d.mode) + x.bandwidth() / 2)
          .y(d => y(d.voyages));

        seriesGroup.append("path")
          .datum(visibleData)
          .attr("class", "line-path")
          .attr("fill", "none")
          .attr("stroke", "#5470C6")
          .attr("stroke-width", 2)
          .transition()
          .duration(300)
          .attr("d", line);

        // Points
        const circles = seriesGroup.selectAll(".line-circle")
          .data(visibleData, d => d.mode);

        circles.enter()
          .append("circle")
          .attr("class", "line-circle")
          .merge(circles)
          .attr("r", 4)
          .attr("fill", "#5470C6")
          .transition()
          .duration(300)
          .attr("cx", d => x(d.mode) + x.bandwidth() / 2)
          .attr("cy", d => y(d.voyages));

        circles.exit().remove();
      }
    }

    // DESSIN INITIAL
    drawChart();

    // Gestion du survol (tooltip)
    svg.on("mousemove", (event) => {
      const [mx, my] = d3.pointer(event, svg.node());
      if (mx < margin.left || mx > (margin.left + innerWidth)
          || my < margin.top || my > (margin.top + innerHeight)) {
        tooltip.style("opacity", 0);
        return;
      }

      // Trouver la catégorie la plus proche
      const domain = x.domain();
      let closest = null;
      let minDist = Infinity;
      domain.forEach(modeVal => {
        const center = x(modeVal) + x.bandwidth()/2 + margin.left;
        const dist = Math.abs(center - mx);
        if (dist < minDist) {
          minDist = dist;
          closest = modeVal;
        }
      });
      const datum = data.find(d => d.mode === closest);
      if (!datum) {
        tooltip.style("opacity", 0);
        return;
      }

      const total = d3.sum(data, d => d.voyages);
      const pc = ((datum.voyages / total) * 100).toFixed(2);

      tooltip.html(`
        <strong>${datum.mode}</strong><br/>
        ${datum.voyages} voyages (${pc}%)
      `);
      const ttNode = tooltip.node();
      const tooltipWidth = ttNode.offsetWidth;
      const tooltipHeight = ttNode.offsetHeight;

      tooltip.style("left", (event.pageX - tooltipWidth/2) + "px")
        .style("top", (event.pageY - tooltipHeight - 10) + "px")
        .style("opacity", 1);
    })
    .on("mouseleave", () => {
      tooltip.style("opacity", 0);
    });

    // --- BRUSH (zoom) ---
    const brushMargin = { top: 10, right: 30, bottom: 20, left: 70 };
    const brushW = 800, brushH = 80;
    const brushInnerW = brushW - brushMargin.left - brushMargin.right;
    const brushInnerH = brushH - brushMargin.top - brushMargin.bottom;

    const brushSvg = d3.select("#brush-svg");
    const brushG = brushSvg.append("g")
      .attr("transform", `translate(${brushMargin.left},${brushMargin.top})`);

    let xBrush = d3.scaleBand()
      .domain(x.domain())
      .range([0, brushInnerW])
      .padding(0.2);

    let yBrush = d3.scaleLinear()
      .domain(y.domain())
      .range([brushInnerH, 0]);

    // Dessin du mini-barchart pour le brush
    brushG.selectAll(".brush-bar")
      .data(data)
      .enter()
      .append("rect")
      .attr("class", "brush-bar")
      .attr("x", d => xBrush(d.mode))
      .attr("width", xBrush.bandwidth())
      .attr("y", d => yBrush(d.voyages))
      .attr("height", d => brushInnerH - yBrush(d.voyages))
      .attr("fill", "#ccc");

    // Axe X mini
    const xAxisBrush = d3.axisBottom(xBrush).tickSizeOuter(0);
    brushG.append("g")
      .attr("transform", `translate(0, ${brushInnerH})`)
      .call(xAxisBrush)
      .selectAll("text")
      .attr("transform", "rotate(30)")
      .style("text-anchor", "start");

    const myBrush = d3.brushX()
      .extent([[0, 0], [brushInnerW, brushInnerH]])
      .on("brush end", brushed);

    brushG.append("g")
      .attr("class", "brush")
      .call(myBrush);

    function brushed({ selection }) {
      if (!selection) return;
      const [x0, x1] = selection;

      // On récupère les catégories sélectionnées
      const selectedDomain = xBrush.domain().filter(mode => {
        const center = xBrush(mode) + xBrush.bandwidth()/2;
        return center >= x0 && center <= x1;
      });
      if (selectedDomain.length > 0) {
        x.domain(selectedDomain);
        updateScalesAndRedraw();
      }
    }

    function updateScalesAndRedraw() {
      // Ajuste l'échelle x
      x.range([0, innerWidth]).padding(0.2);
      // Met à jour l'axe X
      chartG.select(".x-axis")
        .call(xAxis.scale(x))
        .selectAll("text")
        .attr("transform", "rotate(30)")
        .style("text-anchor", "start");

      // Met à jour l'axe Y
      y.domain([0, d3.max(data, d => d.voyages)]).nice();
      chartG.select(".y-axis")
        .call(yAxis.scale(y));

      // Redessine (barres ou ligne)
      drawChart();
    }

    // --- BOUTONS ---

    // 1) Toggle chart type
    d3.select("#toggle-chart").on("click", () => {
      currentType = (currentType === "bar") ? "line" : "bar";
      drawChart();
    });

    // 2) DataView (édition JSON)
    const dataModal = d3.select("#data-view-modal");
    const dataTextarea = d3.select("#data-textarea");
    const openDataViewBtn = d3.select("#open-data-view");
    const closeDataViewBtn = d3.select("#close-data-view");
    const applyDataBtn = d3.select("#apply-data");

    openDataViewBtn.on("click", () => {
      dataTextarea.node().value = JSON.stringify(data, null, 2);
      dataModal.style("display", "flex");
    });
    closeDataViewBtn.on("click", () => {
      dataModal.style("display", "none");
    });
    applyDataBtn.on("click", () => {
      try {
        const newData = JSON.parse(dataTextarea.node().value);
        if (!Array.isArray(newData)) throw new Error("Le JSON doit être un tableau.");
        // Met à jour data
        data = newData;
        // MàJ domain + re-dessin
        x.domain(data.map(d => d.mode));
        y.domain([0, d3.max(data, d => d.voyages)]).nice();

        // MàJ du brush
        xBrush.domain(x.domain());
        yBrush.domain(y.domain());

        // Réinitialise le mini-barchart
        brushG.selectAll(".brush-bar").remove();
        brushG.selectAll(".brush-bar")
          .data(data)
          .enter()
          .append("rect")
          .attr("class", "brush-bar")
          .attr("x", d => xBrush(d.mode))
          .attr("width", xBrush.bandwidth())
          .attr("y", d => yBrush(d.voyages))
          .attr("height", d => brushInnerH - yBrush(d.voyages))
          .attr("fill", "#ccc");

        // Rafraîchit l'axe X mini
        brushG.select(".x-axis-brush")?.remove();
        brushG.append("g")
          .attr("class", "x-axis-brush")
          .attr("transform", `translate(0, ${brushInnerH})`)
          .call(d3.axisBottom(xBrush).tickSizeOuter(0))
          .selectAll("text")
          .attr("transform", "rotate(30)")
          .style("text-anchor", "start");

        // Ferme la modale
        dataModal.style("display", "none");
        updateScalesAndRedraw();
      } catch (e) {
        alert("Erreur de parsing JSON : " + e.message);
      }
    });

    // 3) Restore (réinitialise zoom & type)
    d3.select("#restore-btn").on("click", () => {
      x.domain(data.map(d => d.mode));
      y.domain([0, d3.max(data, d => d.voyages)]).nice();
      // Supprime la sélection brush
      brushG.select(".brush").call(myBrush.move, null);
      // Re-bascule en bar
      currentType = "bar";
      updateScalesAndRedraw();
    });

    // 4) Save as image
    d3.select("#save-as-img").on("click", () => {
      const container = document.getElementById("chart-container");
      html2canvas(container).then(canvas => {
        const link = document.createElement("a");
        link.download = "chart.png";
        link.href = canvas.toDataURL();
        link.click();
      });
    });
  </script>
</body>
</html>
